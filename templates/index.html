{% extends 'layout/base.html' %}
{% block title %}Footwear Inventory{% endblock %}
{% block content %}

<div class="container mt-4">
  <!-- Page Header -->
  <div class="page-header">
    <h2>ðŸ‘Ÿ Footwear Inventory</h2>
    <p class="text-muted">Manage your product catalog</p>
  </div>

  <!-- Search Bar -->
  <form method="GET" action="{{ url_for('index') }}" class="d-flex mb-4" style="max-width: 500px; margin: 0 auto 2rem;">
    <input type="text" name="query" class="form-control me-2" placeholder="Search by name, brand, category, or size..." 
           value="{{ search_query if search_query else '' }}">
    <button type="submit" class="btn btn-primary">
      <i class="fas fa-search"></i> Search
    </button>
  </form>

  <!-- Add Product Button and Enhanced Export -->
  {% if session['role'] in ['admin', 'staff'] %}
  <div class="text-center mb-4">
    <a href="{{ url_for('add_product') }}" class="btn btn-success">
      <i class="fas fa-plus-circle"></i> Add New Footwear
    </a>
    
    <!--  ADVANCED EXPORT BUTTON -->
    <button type="button" class="btn btn-outline-primary ms-2" data-bs-toggle="modal" data-bs-target="#exportModal">
      <i class="fas fa-file-export"></i> Export CSV
    </button>
  </div>
  {% endif %}
  
  <!-- Product Table -->
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead>
        <tr>
          <th>
            <a href="{{ url_for('index', query=search_query, sort='id', order=('desc' if sort_by == 'id' and order == 'asc' else 'asc')) }}" class="text-decoration-none text-dark">
              ID {% if sort_by == 'id' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }}"></i>{% endif %}
            </a>
          </th>
          <th>Photo</th>
          <th>
            <a href="{{ url_for('index', query=search_query, sort='name', order=('desc' if sort_by == 'name' and order == 'asc' else 'asc')) }}" class="text-decoration-none text-dark">
              Name {% if sort_by == 'name' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }}"></i>{% endif %}
            </a>
          </th>
          <th>
            <a href="{{ url_for('index', query=search_query, sort='brand', order=('desc' if sort_by == 'brand' and order == 'asc' else 'asc')) }}" class="text-decoration-none text-dark">
              Brand {% if sort_by == 'brand' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }}"></i>{% endif %}
            </a>
          </th>
          <th>
            <a href="{{ url_for('index', query=search_query, sort='category', order=('desc' if sort_by == 'category' and order == 'asc' else 'asc')) }}" class="text-decoration-none text-dark">
              Category {% if sort_by == 'category' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }}"></i>{% endif %}
            </a>
          </th>
          <th>Size</th>
          <th>
            <a href="{{ url_for('index', query=search_query, sort='stock', order=('desc' if sort_by == 'stock' and order == 'asc' else 'asc')) }}" class="text-decoration-none text-dark">
              Stock {% if sort_by == 'stock' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }}"></i>{% endif %}
            </a>
          </th>
          <th>
            <a href="{{ url_for('index', query=search_query, sort='price', order=('desc' if sort_by == 'price' and order == 'asc' else 'asc')) }}" class="text-decoration-none text-dark">
              Price {% if sort_by == 'price' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }}"></i>{% endif %}
            </a>
          </th>
          <th>
            <a href="{{ url_for('index', query=search_query, sort='created_at', order=('desc' if sort_by == 'created_at' and order == 'asc' else 'asc')) }}" class="text-decoration-none text-dark">
              Created {% if sort_by == 'created_at' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }}"></i>{% endif %}
            </a>
          </th>
          
          <!--  SEPARATED ACTION COLUMNS -->
          {% if session['role'] in ['admin', 'staff'] %}
          <th class="text-center">Actions</th>
          <th class="text-center">Stock Control</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for product in products %}
        <tr>
          <td><span class="badge bg-secondary">{{ product.id }}</span></td>
          <td>
            {% if product.image %}
              <img src="{{ url_for('static', filename='uploads/' + product.image) }}"
                   alt="{{ product.name }}"
                   class="img-thumbnail"
                   data-bs-toggle="modal"
                   data-bs-target="#imgModal{{ product.id }}">
              
              <!-- Image Modal -->
              <div class="modal fade" id="imgModal{{ product.id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                  <div class="modal-content bg-transparent border-0">
                    <div class="modal-body text-center p-0">
                      <img src="{{ url_for('static', filename='uploads/' + product.image) }}"
                           class="img-fluid rounded shadow-lg">
                    </div>
                  </div>
                </div>
              </div>
            {% else %}
              <div class="text-muted small">No Image</div>
            {% endif %}
          </td>
          <td><strong>{{ product.name }}</strong></td>
          <td>{{ product.brand or 'N/A' }}</td>
          <td><span class="badge bg-light text-dark">{{ product.category or 'N/A' }}</span></td>
          <td>{{ product.size }} <small class="text-muted">{{ product.size_unit }}</small></td>
          <td>
            {% if product.stock < 5 %}
              <span class="badge bg-warning text-dark">{{ product.stock }}</span>
            {% else %}
              <span class="badge bg-success">{{ product.stock }}</span>
            {% endif %}
          </td>
          <td><strong>â‚±{{ "%.2f"|format(product.price) }}</strong></td>
          <td><small>{{ product.created_at|manila_time if product.created_at else 'N/A' }}</small></td>

          {% if session['role'] in ['admin', 'staff'] %}
          <!--  COLUMN 1: Action Buttons -->
          <td class="text-center">
            <div class="action-buttons-column">
              <a href="{{ url_for('product_history', product_id=product.id) }}" 
                 class="btn btn-sm btn-info mb-1 w-100" 
                 title="View History">
                <i class="fas fa-history"></i> History
              </a>
              
              <a href="{{ url_for('edit_product', id=product.id) }}" 
                 class="btn btn-sm btn-warning mb-1 w-100" 
                 title="Edit Product">
                <i class="fas fa-edit"></i> Edit
              </a>
              
              {% if session['role'] == 'admin' %}
                <a href="{{ url_for('delete_product', id=product.id) }}" 
                   class="btn btn-sm btn-danger w-100" 
                   title="Delete Product"
                   onclick="return confirm('ðŸš¨ DELETE: {{ product.name }}? This cannot be undone!');">
                  <i class="fas fa-trash"></i> Delete
                </a>
              {% endif %}
            </div>
          </td>

          <!--  COLUMN 2: Stock Controls -->
          <td class="text-center">
            <div class="stock-controls-column">
              <!-- Add Stock -->
              <form action="{{ url_for('add_stock', product_id=product.id) }}" 
                    method="POST" 
                    class="stock-form-vertical mb-2"
                    onsubmit="return confirmAddStock(event);">
                <input type="number" name="added_qty" min="1" max="1000" 
                       placeholder="Qty" class="form-control form-control-sm mb-1" required>
                <button type="submit" class="btn btn-sm btn-success w-100">
                  <i class="fas fa-plus"></i> Add
                </button>
              </form>

              <!-- Deduct Stock -->
              <form action="{{ url_for('deduct_stock', product_id=product.id) }}" 
                    method="POST" 
                    class="stock-form-vertical"
                    onsubmit="return confirmDeductStock(event);">
                <input type="number" name="deduct_qty" min="1" 
                       placeholder="Qty" class="form-control form-control-sm mb-1" required>
                <button type="submit" class="btn btn-sm btn-danger w-100">
                  <i class="fas fa-minus"></i> Deduct
                </button>
              </form>
            </div>
          </td>
          {% endif %}
        </tr>
        {% endfor %}
        
        {% if not products %}
        <tr>
          <td colspan="12" class="text-center py-5 text-muted">
            <i class="fas fa-box-open fa-3x mb-3 opacity-50"></i>
            <p>No products found{% if search_query %} matching "{{ search_query }}"{% endif %}.</p>
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>

    <!--  PAGINATION SECTION -->
    <div class="pagination-container mt-4">
      <div class="row align-items-center">
        <div class="col-md-4">
          <p class="text-muted mb-0">
            Showing {{ (pagination.page - 1) * per_page + 1 }} - 
            {{ (pagination.page - 1) * per_page + products|length }} of {{ pagination.total }} items
          </p>
        </div>
        <div class="col-md-4 text-center">
          <form method="GET" class="d-inline-flex align-items-center">
            {% if search_query %}
              <input type="hidden" name="query" value="{{ search_query }}">
            {% endif %}
            {% if sort_by %}
              <input type="hidden" name="sort" value="{{ sort_by }}">
            {% endif %}
            {% if order %}
              <input type="hidden" name="order" value="{{ order }}">
            {% endif %}
            <label class="me-2 small">Per page:</label>
            <select name="per_page" class="form-select form-select-sm" style="width: auto;" onchange="this.form.submit()">
              <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
              <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
              <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
              <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
            </select>
          </form>
        </div>
        <div class="col-md-4">
          <nav aria-label="Page navigation" class="float-end">
            <ul class="pagination glass-pagination">
              <!-- Previous Page -->
              <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                <a class="page-link" href="
                  {% if pagination.has_prev %}
                    {{ url_for('index', page=pagination.prev_num, per_page=per_page, sort=sort_by, order=order, query=search_query) }}
                  {% else %}
                    #
                  {% endif %}" aria-label="Previous">
                  <i class="fas fa-chevron-left"></i>
                </a>
              </li>

              <!-- Page Numbers -->
              {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if page_num %}
                  <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('index', page=page_num, per_page=per_page, sort=sort_by, order=order, query=search_query) }}">
                      {{ page_num }}
                    </a>
                  </li>
                {% else %}
                  <li class="page-item disabled">
                    <span class="page-link">...</span>
                  </li>
                {% endif %}
              {% endfor %}

              <!-- Next Page -->
              <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                <a class="page-link" href="
                  {% if pagination.has_next %}
                    {{ url_for('index', page=pagination.next_num, per_page=per_page, sort=sort_by, order=order, query=search_query) }}
                  {% else %}
                    #
                  {% endif %}" aria-label="Next">
                  <i class="fas fa-chevron-right"></i>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<!--   EXPORT CSV MODAL -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content glass-card">
      <div class="modal-header">
        <h5 class="modal-title" id="exportModalLabel">
          <i class="fas fa-file-export"></i> CSV Export
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="exportForm" method="GET" action="{{ url_for('export_csv') }}" onsubmit="return validateExport()">
        <div class="modal-body">
          
          <!--  FILTER SECTION -->
          <h6 class="text-success mb-3"><i class="fas fa-filter"></i> Apply Filters (Optional)</h6>
          
          <div class="row g-3 mb-4">
            <!-- âœ… ENHANCED: Dynamic Brand Filter -->
            <div class="col-md-6">
              <label class="form-label">Brand</label>
              <input type="text" name="brand_filter" class="form-control form-control-sm" 
                     placeholder="Type any brand..." list="brandList">
              {% if unique_brands %}
              <datalist id="brandList">
                {% for brand in unique_brands %}
                  <option value="{{ brand }}">
                {% endfor %}
              </datalist>
              {% endif %}
            </div>
            
            <!-- Category Filter -->
            <div class="col-md-6">
              <label class="form-label">Category</label>
              <select name="category_filter" class="form-select form-select-sm">
                <option value="">All Categories</option>
                {% for cat in ['Sneakers', 'Running', 'Boots', 'Sandals', 'Formal'] %}
                  <option value="{{ cat }}">{{ cat }}</option>
                {% endfor %}
              </select>
            </div>
            
            <!-- Size Filter -->
            <div class="col-md-6">
              <label class="form-label">Size Range</label>
              <div class="input-group input-group-sm">
                <input type="text" name="size_min" class="form-control" placeholder="Min (e.g., 8)">
                <span class="input-group-text">-</span>
                <input type="text" name="size_max" class="form-control" placeholder="Max (e.g., 12)">
              </div>
            </div>
            
            <!-- Stock Range -->
            <div class="col-md-6">
              <label class="form-label">Stock Range</label>
              <div class="input-group input-group-sm">
                <input type="number" name="stock_min" class="form-control" placeholder="Min" min="0">
                <span class="input-group-text">-</span>
                <input type="number" name="stock_max" class="form-control" placeholder="Max" min="0">
              </div>
            </div>
            
            <!-- Price Range -->
            <div class="col-md-6">
              <label class="form-label">Price Range (â‚±)</label>
              <div class="input-group input-group-sm">
                <input type="number" name="price_min" class="form-control" placeholder="Min" min="0" step="0.01">
                <span class="input-group-text">-</span>
                <input type="number" name="price_max" class="form-control" placeholder="Max" min="0" step="0.01">
              </div>
            </div>
            
            <!-- Date Range -->
            <div class="col-md-6">
              <label class="form-label">Date Range</label>
              <div class="row g-1">
                <div class="col-6">
                  <input type="date" name="date_start" class="form-control form-control-sm">
                </div>
                <div class="col-6">
                  <input type="date" name="date_end" class="form-control form-control-sm">
                </div>
              </div>
            </div>
          </div>
          
          <hr>
          
          <!--  COLUMN SELECTION -->
          <h6 class="text-primary mb-3"><i class="fas fa-columns"></i> Select Columns</h6>
          <div class="row g-3">
            <div class="col-md-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="checkAll" checked onchange="toggleAllColumns()">
                <label class="form-check-label fw-bold" for="checkAll">
                  <i class="fas fa-list"></i> Select All
                </label>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="form-check">
                <input class="form-check-input column-check" type="checkbox" name="columns" value="name" id="nameCheck" checked>
                <label class="form-check-label" for="nameCheck">Product Name</label>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="form-check">
                <input class="form-check-input column-check" type="checkbox" name="columns" value="brand" id="brandCheck" checked>
                <label class="form-check-label" for="brandCheck">Brand</label>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="form-check">
                <input class="form-check-input column-check" type="checkbox" name="columns" value="category" id="categoryCheck" checked>
                <label class="form-check-label" for="categoryCheck">Category</label>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="form-check">
                <input class="form-check-input column-check" type="checkbox" name="columns" value="size" id="sizeCheck" checked>
                <label class="form-check-label" for="sizeCheck">Size</label>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="form-check">
                <input class="form-check-input column-check" type="checkbox" name="columns" value="stock" id="stockCheck" checked>
                <label class="form-check-label" for="stockCheck">Stock Quantity</label>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="form-check">
                <input class="form-check-input column-check" type="checkbox" name="columns" value="price" id="priceCheck" checked>
                <label class="form-check-label" for="priceCheck">Price</label>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="form-check">
                <input class="form-check-input column-check" type="checkbox" name="columns" value="created_at" id="createdCheck" checked>
                <label class="form-check-label" for="createdCheck">Created Date</label>
              </div>
            </div>
          </div>
          
          <hr class="my-3">
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="include_headers" value="true" id="headersCheck" checked>
              <label class="form-check-label" for="headersCheck">
                <i class="fas fa-header"></i> Include Column Headers
              </label>
            </div>
          </div>
          
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-download"></i> Download CSV
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
//   Export Validation
function validateExport() {
  const checkedBoxes = document.querySelectorAll('.column-check:checked');
  const categoryFilter = document.querySelector('select[name="category_filter"]').value;
  const hasFilters = categoryFilter || 
                    document.querySelector('input[name="size_min"]').value ||
                    document.querySelector('input[name="size_max"]').value ||
                    document.querySelector('input[name="stock_min"]').value ||
                    document.querySelector('input[name="stock_max"]').value ||
                    document.querySelector('input[name="price_min"]').value ||
                    document.querySelector('input[name="price_max"]').value ||
                    document.querySelector('input[name="date_start"]').value ||
                    document.querySelector('input[name="date_end"]').value;
  
  if (checkedBoxes.length === 0) {
    alert('âŒ Please select at least one column to export.');
    return false;
  }
  
  const filterCount = hasFilters ? ' (with active filters)' : ' (all products)';
  const columnCount = checkedBoxes.length;
  
  return confirm(`ðŸ“„ Export ${columnCount} columns${filterCount}?\n\nClick OK to download.`);
}

//  Select All Toggle
function toggleAllColumns() {
  const checkAll = document.getElementById('checkAll');
  const columnChecks = document.querySelectorAll('.column-check');
  
  columnChecks.forEach(checkbox => {
    checkbox.checked = checkAll.checked;
  });
}

//  Initialize column checkbox
document.addEventListener('DOMContentLoaded', function() {
  const columnChecks = document.querySelectorAll('.column-check');
  const checkAll = document.getElementById('checkAll');
  
  columnChecks.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const allChecked = Array.from(columnChecks).every(cb => cb.checked);
      const someChecked = Array.from(columnChecks).some(cb => cb.checked);
      
      checkAll.checked = allChecked;
      checkAll.indeterminate = !allChecked && someChecked;
    });
  });
});

function confirmAddStock(event) {
  const qty = event.target.querySelector('input[name="added_qty"]').value;
  return confirm(`âž• Add ${qty} unit(s) to stock?`);
}

function confirmDeductStock(event) {
  const qty = event.target.querySelector('input[name="deduct_qty"]').value;
  return confirm(`âž– Deduct ${qty} unit(s) from stock? This cannot be undone!`);
}
</script>

{% endblock %}