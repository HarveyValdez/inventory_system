{% extends 'layout/base.html' %}
{% block title %}Footwear Inventory{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- Professional Header -->
  <div class="page-header mb-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div>
        <h2 class="gradient-text mb-0"><i class="fas fa-shoe-prints"></i> Footwear Inventory</h2>
        <p class="text-muted mb-0 mt-1">Manage your premium product catalog</p>
      </div>
      <div class="d-flex gap-2">
        {% if session['role'] in ['admin', 'staff'] %}
          <a href="{{ url_for('add_product') }}" class="btn btn-success pulse-btn">
            <i class="fas fa-plus-circle"></i> Add Product
          </a>
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exportModal">
            <i class="fas fa-file-export"></i> Export CSV
          </button>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Glassmorphism Search Card -->
  <div class="card glass-card p-4 mb-4">
    <form method="GET" action="{{ url_for('index') }}" class="row g-3 align-items-center">
      <div class="col-md-10">
        <div class="input-group">
          <span class="input-group-text bg-glass"><i class="fas fa-search"></i></span>
          <input type="text" name="query" class="form-control" 
                 placeholder="Search by name, brand, category, or size..." 
                 value="{{ search_query if search_query else '' }}">
        </div>
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">
          <i class="fas fa-search"></i> Search
        </button>
      </div>
    </form>
  </div>

  <!-- Quick Stats -->
  {% if session.get('role') == 'admin' %}
 
  <div class="row g-2 justify-content-center mb-3">  <!-- Reduced gap & bottom margin -->
    <div class="col-md-4">
      <div class="card glass-card text-center p-2">  <!-- Reduced padding -->
        <i class="fas fa-boxes fa-2x gradient-text mb-1"></i>  <!-- Reduced margin -->
        <h5 class="gradient-text mb-0">{{ pagination.total }}</h5>
        <small class="text-muted">Total Products</small>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card glass-card text-center p-2">
        <i class="fas fa-exclamation-triangle fa-2x gradient-text mb-1"></i>
        <h5 class="gradient-text mb-0">{{ low_stock_count }}</h5>
        <small class="text-muted">Low Stock Alerts</small>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card glass-card text-center p-2">
        <i class="fas fa-clock fa-2x gradient-text mb-1"></i>
        <h5 class="gradient-text mb-0">{{ pagination.page }}</h5>
        <small class="text-muted">Current Page</small>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Advanced Product Table -->
  <div class="card glass-card overflow-hidden">
    <div class="card-header bg-transparent border-bottom">
      <h6 class="mb-0 gradient-text"><i class="fas fa-list-ul"></i> Product Catalog</h6>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width: 60px;">
              <a href="{{ url_for('index', query=search_query, sort='id', order=('desc' if sort_by == 'id' and order == 'asc' else 'asc')) }}" class="sort-link">
                ID {% if sort_by == 'id' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }}"></i>{% endif %}
              </a>
            </th>
            <th style="width: 80px;">Photo</th>
            <th>
              <a href="{{ url_for('index', query=search_query, sort='name', order=('desc' if sort_by == 'name' and order == 'asc' else 'asc')) }}" class="sort-link">
                Name {% if sort_by == 'name' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }}"></i>{% endif %}
              </a>
            </th>
            <th>
              <a href="{{ url_for('index', query=search_query, sort='brand', order=('desc' if sort_by == 'brand' and order == 'asc' else 'asc')) }}" class="sort-link">
                Brand {% if sort_by == 'brand' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }}"></i>{% endif %}
              </a>
            </th>
            <th>
              <a href="{{ url_for('index', query=search_query, sort='category', order=('desc' if sort_by == 'category' and order == 'asc' else 'asc')) }}" class="sort-link">
                Category {% if sort_by == 'category' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }}"></i>{% endif %}
              </a>
            </th>
            <th>Size</th>
            <th>
              <a href="{{ url_for('index', query=search_query, sort='stock', order=('desc' if sort_by == 'stock' and order == 'asc' else 'asc')) }}" class="sort-link">
                Stock {% if sort_by == 'stock' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }}"></i>{% endif %}
              </a>
            </th>
            <th>
              <a href="{{ url_for('index', query=search_query, sort='price', order=('desc' if sort_by == 'price' and order == 'asc' else 'asc')) }}" class="sort-link">
                Price {% if sort_by == 'price' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }}"></i>{% endif %}
              </a>
            </th>
            <th style="width: 120px;">
              <a href="{{ url_for('index', query=search_query, sort='created_at', order=('desc' if sort_by == 'created_at' and order == 'asc' else 'asc')) }}" class="sort-link">
                Created {% if sort_by == 'created_at' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }}"></i>{% endif %}
              </a>
            </th>
            {% if session['role'] in ['admin', 'staff'] %}
            <th class="text-center" style="width: 100px;">Actions</th>
            <th class="text-center" style="width: 120px;">Stock Control</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for product in products %}
          <tr class="product-row">
            <td><span class="badge bg-secondary">{{ product.id }}</span></td>
            <td>
              {% if product.image %}
                <img src="{{ url_for('static', filename='uploads/' + product.image) }}"
                     alt="{{ product.name }}" class="img-thumbnail" data-bs-toggle="modal"
                     data-bs-target="#imgModal{{ product.id }}">
              {% else %}
                <div class="text-muted small">No Image</div>
              {% endif %}
            </td>
            <td><strong class="product-name">{{ product.name }}</strong></td>
            <td>{{ product.brand or 'N/A' }}</td>
            <td><span class="badge category-badge">{{ product.category or 'N/A' }}</span></td>
            <td><span class="size-badge">{{ product.size }}{% if product.size_unit %} {{ product.size_unit }}{% endif %}</span></td>
            <td>
              {% if product.stock < 5 %}
                <span class="badge stock-badge stock-low">{{ product.stock }}</span>
              {% elif product.stock == 0 %}
                <span class="badge stock-badge stock-zero">{{ product.stock }}</span>
              {% else %}
                <span class="badge stock-badge stock-normal">{{ product.stock }}</span>
              {% endif %}
            </td>
            <td><strong class="price-tag">â‚±{{ "%.2f"|format(product.price) }}</strong></td>
            <td><small class="text-muted">{{ product.created_at|manila_time if product.created_at else 'N/A' }}</small></td>

            {% if session['role'] in ['admin', 'staff'] %}
            <td class="text-center">
              <div class="btn-group-vertical w-100" role="group">
                <a href="{{ url_for('product_history', product_id=product.id) }}" 
                   class="btn btn-glass btn-sm mb-1" title="View History">
                  <i class="fas fa-history"></i> History
                </a>
                <a href="{{ url_for('edit_product', id=product.id) }}" 
                   class="btn btn-glass btn-sm mb-1" title="Edit Product">
                  <i class="fas fa-edit"></i> Edit
                </a>
                {% if session['role'] == 'admin' %}
                <a href="{{ url_for('delete_product', id=product.id) }}" 
                   class="btn btn-glass btn-sm btn-danger" title="Delete Product"
                   onclick="return confirm('ðŸš¨ DELETE: {{ product.name }}? This cannot be undone!');">
                  <i class="fas fa-trash"></i> Delete
                </a>
                {% endif %}
              </div>
            </td>
            <td class="text-center">
              <div class="d-flex flex-column gap-1">
                <!-- Add Stock -->
                <form action="{{ url_for('add_stock', product_id=product.id) }}" method="POST" 
                      class="stock-form" onsubmit="return confirmAddStock(event);">
                  <div class="input-group input-group-sm">
                    <input type="number" name="added_qty" class="form-control" placeholder="Qty" 
                           min="1" max="1000" required>
                    <button type="submit" class="btn btn-glass btn-success">
                      <i class="fas fa-plus"></i>
                    </button>
                  </div>
                </form>
                <!-- Deduct Stock -->
                <form action="{{ url_for('deduct_stock', product_id=product.id) }}" method="POST" 
                      class="stock-form" onsubmit="return confirmDeductStock(event);">
                  <div class="input-group input-group-sm">
                    <input type="number" name="deduct_qty" class="form-control" placeholder="Qty" 
                           min="1" required>
                    <button type="submit" class="btn btn-glass btn-warning">
                      <i class="fas fa-minus"></i>
                    </button>
                  </div>
                </form>
              </div>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
          
          {% if not products %}
          <tr>
            <td colspan="12" class="text-center py-5 text-muted">
              <i class="fas fa-box-open fa-3x mb-3 opacity-50"></i>
              <p>No products found{% if search_query %} matching "{{ search_query }}"{% endif %}.</p>
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Enhanced Pagination -->
  {% if pagination.total > 0 %}
  <div class="pagination-container mt-4">
    <div class="row align-items-center">
      <div class="col-md-4">
        <small class="text-muted">
          Showing {{ (pagination.page - 1) * per_page + 1 }} - 
          {{ (pagination.page - 1) * per_page + products|length }} of {{ pagination.total }} items
        </small>
      </div>
      <div class="col-md-4 text-center">
        <form method="GET" class="d-inline-flex align-items-center">
          {% if search_query %}<input type="hidden" name="query" value="{{ search_query }}">{% endif %}
          {% if sort_by %}<input type="hidden" name="sort" value="{{ sort_by }}">{% endif %}
          {% if order %}<input type="hidden" name="order" value="{{ order }}">{% endif %}
          <label class="me-2 small text-muted">Per page:</label>
          <select name="per_page" class="form-select form-select-sm" style="width: auto;" onchange="this.form.submit()">
            <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
            <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
          </select>
        </form>
      </div>
      <div class="col-md-4">
        <nav class="float-end">
          <ul class="pagination glass-pagination mb-0">
            <!-- Previous -->
            <li class="page-item {{ 'disabled' if not pagination.has_prev }}">
              <a class="page-link" href="{{ url_for('index', page=pagination.prev_num if pagination.has_prev else 1, 
                per_page=per_page, sort=sort_by, order=order, query=search_query) }}">
                <i class="fas fa-chevron-left"></i>
              </a>
            </li>
            <!-- Page numbers -->
            {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
              {% if page_num %}
                <li class="page-item {{ 'active' if page_num == pagination.page }}">
                  <a class="page-link" href="{{ url_for('index', page=page_num, per_page=per_page, 
                    sort=sort_by, order=order, query=search_query) }}">{{ page_num }}</a>
                </li>
              {% else %}
                <li class="page-item disabled"><span class="page-link">â€¦</span></li>
              {% endif %}
            {% endfor %}
            <!-- Next -->
            <li class="page-item {{ 'disabled' if not pagination.has_next }}">
              <a class="page-link" href="{{ url_for('index', page=pagination.next_num if pagination.has_next else pagination.page, 
                per_page=per_page, sort=sort_by, order=order, query=search_query) }}">
                <i class="fas fa-chevron-right"></i>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Enhanced Export CSV Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content glass-card">
      <div class="modal-header">
        <h5 class="modal-title gradient-text"><i class="fas fa-file-export"></i> Advanced CSV Export</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="GET" action="{{ url_for('export_csv') }}" onsubmit="return validateExport()">
        <div class="modal-body">
          <!-- Filter Section -->
          <div class="card mb-4 border-0" style="background: rgba(0,184,148,0.03);">
            <div class="card-body">
              <h6 class="mb-3 gradient-text"><i class="fas fa-filter"></i> Apply Filters (Optional)</h6>
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Brand</label>
                  <input type="text" name="brand_filter" class="form-control form-control-sm" 
                         placeholder="Type any brand..." list="brandList">
                  {% if unique_brands %}
                  <datalist id="brandList">
                    {% for brand in unique_brands %}
                      <option value="{{ brand }}">
                    {% endfor %}
                  </datalist>
                  {% endif %}
                </div>
                <div class="col-md-6">
                  <label class="form-label">Category</label>
                  <select name="category_filter" class="form-select form-select-sm">
                    <option value="">All Categories</option>
                    {% for cat in ['Sneakers', 'Running', 'Boots', 'Sandals', 'Formal'] %}
                      <option value="{{ cat }}">{{ cat }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- Column Selection -->
          <div class="card border-0" style="background: rgba(253,203,110,0.03);">
            <div class="card-body">
              <h6 class="mb-3 gradient-text"><i class="fas fa-columns"></i> Select Columns</h6>
              <div class="row g-3">
                <div class="col-md-12">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="checkAll" checked onchange="toggleAllColumns()">
                    <label class="form-check-label fw-bold" for="checkAll">Select All</label>
                  </div>
                </div>
                {% for col in ['name', 'brand', 'category', 'size', 'stock', 'price', 'created_at'] %}
                <div class="col-md-6">
                  <div class="form-check">
                    <input class="form-check-input column-check" type="checkbox" name="columns" value="{{ col }}" 
                           id="{{ col }}Check" checked>
                    <label class="form-check-label" for="{{ col }}Check">{{ col.replace('_', ' ').title() }}</label>
                  </div>
                </div>
                {% endfor %}
              </div>
              <hr class="my-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="include_headers" value="true" checked>
                <label class="form-check-label">Include Column Headers</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-download"></i> Download CSV
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Image Modals -->
{% for product in products %}
  {% if product.image %}
  <div class="modal fade" id="imgModal{{ product.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content bg-transparent border-0">
        <div class="modal-body text-center p-0">
          <img src="{{ url_for('static', filename='uploads/' + product.image) }}" 
               class="img-fluid rounded shadow-lg">
        </div>
      </div>
    </div>
  </div>
  {% endif %}
{% endfor %}

<!-- JavaScript -->
<script>
// Validation for export
function validateExport() {
  const checkedBoxes = document.querySelectorAll('.column-check:checked');
  if (checkedBoxes.length === 0) {
    alert('âŒ Please select at least one column to export.');
    return false;
  }
  return true;
}

// Toggle all columns
function toggleAllColumns() {
  const checkAll = document.getElementById('checkAll');
  document.querySelectorAll('.column-check').forEach(cb => cb.checked = checkAll.checked);
}

// Stock confirmation
function confirmAddStock(event) {
  const qty = event.target.querySelector('input[name="added_qty"]').value;
  return confirm(`âž• Add ${qty} unit(s) to stock?`);
}

function confirmDeductStock(event) {
  const qty = event.target.querySelector('input[name="deduct_qty"]').value;
  return confirm(`âž– Deduct ${qty} unit(s) from stock? This cannot be undone!`);
}

// Initialize column checkboxes
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.column-check').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const allChecked = document.querySelectorAll('.column-check').length === document.querySelectorAll('.column-check:checked').length;
      document.getElementById('checkAll').checked = allChecked;
    });
  });
});
</script>

<style>
/* Glassmorphism enhancements for index page */
.stat-card { transition: all var(--transition-fast); }
.stat-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-accent); }

.sort-link {
  color: var(--text-primary);
  text-decoration: none;
  font-weight: 600;
  transition: all var(--transition-fast);
}
.sort-link:hover {
  color: var(--accent-primary);
  text-shadow: 0 0 8px rgba(0, 184, 148, 0.3);
}

.product-row {
  transition: all var(--transition-fast);
  border-left: 4px solid transparent;
}
.product-row:hover {
  background: rgba(0, 184, 148, 0.05);
  border-left-color: var(--accent-primary);
}

.product-name { color: var(--text-primary); transition: all var(--transition-fast); }
.product-row:hover .product-name { color: var(--accent-primary); }

.category-badge {
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  font-weight: 500;
  transition: all var(--transition-fast);
}

.size-badge {
  background: rgba(253, 203, 110, 0.15);
  padding: 0.25rem 0.5rem;
  border-radius: 8px;
  font-weight: 600;
}

.stock-badge {
  font-size: 0.9rem;
  padding: 0.5rem 0.75rem;
  transition: all var(--transition-fast);
}
.stock-low { background: var(--warning-color); color: var(--text-primary); }
.stock-zero { background: var(--danger-color); }
.stock-normal { background: var(--success-color); }

.price-tag {
  color: var(--accent-primary);
  font-weight: 700;
  transition: all var(--transition-fast);
}
.product-row:hover .price-tag { color: var(--accent-secondary); }

.btn-group-vertical .btn-glass {
  border-radius: var(--border-radius-xs);
  margin-bottom: 0.25rem;
  font-size: 0.8rem;
  padding: 0.4rem;
}
.btn-glass:last-child { margin-bottom: 0; }

.stock-form .input-group-sm {
  gap: 0.25rem;
}
.stock-form input {
  background: rgba(255, 255, 255, 0.7);
  border: 1px solid var(--glass-border);
  text-align: center;
}
.stock-form button {
  padding: 0.25rem 0.5rem;
}

/* Pagination enhancements */
.glass-pagination .page-link {
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  color: var(--text-primary);
}
.glass-pagination .page-item.active .page-link {
  background: var(--accent-gradient);
  border-color: var(--accent-primary);
  color: white;
}
.glass-pagination .page-item.disabled .page-link {
  background: rgba(0, 0, 0, 0.05);
  color: var(--text-muted);
}
/* Stock Control Fix - Force Horizontal Layout */
.stock-form .input-group {
  flex-direction: row !important;
  align-items: center;
  gap: 0.3rem;
}

.stock-form .input-group input.form-control {
  flex: 1;
  min-width: 60px;
  max-width: 80px;
}

.stock-form .input-group button {
  flex: 0 0 auto;
  padding: 0.375rem 0.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Ensure icons center properly */
.stock-form .input-group button i {
  margin: 0;
}
</style>
{% endblock %}