{% extends 'layout/base.html' %}
{% block title %}Footwear Inventory{% endblock %}
{% block content %}

<div class="container mt-4">
  <!-- Page Header -->
  <div class="page-header">
    <h2>ðŸ‘Ÿ Footwear Inventory</h2>
    <p class="text-muted">Manage your product catalog</p>
  </div>

  <!-- Search Bar -->
  <form method="GET" action="{{ url_for('index') }}" class="d-flex mb-4" style="max-width: 500px; margin: 0 auto 2rem;">
    <input type="text" name="query" class="form-control me-2" placeholder="Search by name, brand, category, or size..." 
           value="{{ search_query if search_query else '' }}">
    <button type="submit" class="btn btn-primary">
      <i class="fas fa-search"></i> Search
    </button>
  </form>

  <!-- Add Product Button -->

    {% if session['role'] in ['admin', 'staff'] %}
  <div class="text-center mb-4">
    <a href="{{ url_for('add_product') }}" class="btn btn-success">
      <i class="fas fa-plus-circle"></i> Add New Footwear
    </a>
    {% if session['role'] == 'admin' %}
    <a href="{{ url_for('export_csv') }}" class="btn btn-outline-primary ms-2">
      <i class="fas fa-file-export"></i> Export CSV
    </a>
    {% endif %}
  </div>
  {% endif %}
  
  <!-- Product Table -->
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead>
        <tr>
          <th>
            <a href="{{ url_for('index', query=search_query, sort='id', order=('desc' if sort_by == 'id' and order == 'asc' else 'asc')) }}" class="text-decoration-none text-dark">
              ID {% if sort_by == 'id' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }}"></i>{% endif %}
            </a>
          </th>
          <th>Photo</th>
          <th>
            <a href="{{ url_for('index', query=search_query, sort='name', order=('desc' if sort_by == 'name' and order == 'asc' else 'asc')) }}" class="text-decoration-none text-dark">
              Name {% if sort_by == 'name' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }}"></i>{% endif %}
            </a>
          </th>
          <th>
            <a href="{{ url_for('index', query=search_query, sort='brand', order=('desc' if sort_by == 'brand' and order == 'asc' else 'asc')) }}" class="text-decoration-none text-dark">
              Brand {% if sort_by == 'brand' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }}"></i>{% endif %}
            </a>
          </th>
          <th>
            <a href="{{ url_for('index', query=search_query, sort='category', order=('desc' if sort_by == 'category' and order == 'asc' else 'asc')) }}" class="text-decoration-none text-dark">
              Category {% if sort_by == 'category' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }}"></i>{% endif %}
            </a>
          </th>
          <th>Size</th>
          <th>
            <a href="{{ url_for('index', query=search_query, sort='stock', order=('desc' if sort_by == 'stock' and order == 'asc' else 'asc')) }}" class="text-decoration-none text-dark">
              Stock {% if sort_by == 'stock' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }}"></i>{% endif %}
            </a>
          </th>
          <th>
            <a href="{{ url_for('index', query=search_query, sort='price', order=('desc' if sort_by == 'price' and order == 'asc' else 'asc')) }}" class="text-decoration-none text-dark">
              Price {% if sort_by == 'price' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }}"></i>{% endif %}
            </a>
          </th>
          <th>
            <a href="{{ url_for('index', query=search_query, sort='created_at', order=('desc' if sort_by == 'created_at' and order == 'asc' else 'asc')) }}" class="text-decoration-none text-dark">
              Created {% if sort_by == 'created_at' %}<i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }}"></i>{% endif %}
            </a>
          </th>
          
          <!-- âœ… SEPARATED ACTION COLUMNS -->
          {% if session['role'] in ['admin', 'staff'] %}
          <th class="text-center">Actions</th>
          <th class="text-center">Stock Control</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for product in products %}
        <tr>
          <td><span class="badge bg-secondary">{{ product.id }}</span></td>
          <td>
            {% if product.image %}
              <img src="{{ url_for('static', filename='uploads/' + product.image) }}"
                   alt="{{ product.name }}"
                   class="img-thumbnail"
                   data-bs-toggle="modal"
                   data-bs-target="#imgModal{{ product.id }}">
              
              <!-- Image Modal -->
              <div class="modal fade" id="imgModal{{ product.id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                  <div class="modal-content bg-transparent border-0">
                    <div class="modal-body text-center p-0">
                      <img src="{{ url_for('static', filename='uploads/' + product.image) }}"
                           class="img-fluid rounded shadow-lg">
                    </div>
                  </div>
                </div>
              </div>
            {% else %}
              <div class="text-muted small">No Image</div>
            {% endif %}
          </td>
          <td><strong>{{ product.name }}</strong></td>
          <td>{{ product.brand or 'N/A' }}</td>
          <td><span class="badge bg-light text-dark">{{ product.category or 'N/A' }}</span></td>
          <td>{{ product.size }} <small class="text-muted">{{ product.size_unit }}</small></td>
          <td>
            {% if product.stock < 5 %}
              <span class="badge bg-warning text-dark">{{ product.stock }}</span>
            {% else %}
              <span class="badge bg-success">{{ product.stock }}</span>
            {% endif %}
          </td>
          <td><strong>â‚±{{ "%.2f"|format(product.price) }}</strong></td>
          <td><small>{{ product.created_at|manila_time if product.created_at else 'N/A' }}</small></td>

          {% if session['role'] in ['admin', 'staff'] %}
          <!-- âœ… COLUMN 1: Action Buttons -->
          <td class="text-center">
            <div class="action-buttons-column">
              <a href="{{ url_for('product_history', product_id=product.id) }}" 
                 class="btn btn-sm btn-info mb-1 w-100" 
                 title="View History">
                <i class="fas fa-history"></i> History
              </a>
              
              <a href="{{ url_for('edit_product', id=product.id) }}" 
                 class="btn btn-sm btn-warning mb-1 w-100" 
                 title="Edit Product">
                <i class="fas fa-edit"></i> Edit
              </a>
              
              {% if session['role'] == 'admin' %}
                <a href="{{ url_for('delete_product', id=product.id) }}" 
                   class="btn btn-sm btn-danger w-100" 
                   title="Delete Product"
                   onclick="return confirm('ðŸš¨ DELETE: {{ product.name }}? This cannot be undone!');">
                  <i class="fas fa-trash"></i> Delete
                </a>
              {% endif %}
            </div>
          </td>

          <!-- âœ… COLUMN 2: Stock Controls -->
          <td class="text-center">
            <div class="stock-controls-column">
              <!-- Add Stock -->
              <form action="{{ url_for('add_stock', product_id=product.id) }}" 
                    method="POST" 
                    class="stock-form-vertical mb-2"
                    onsubmit="return confirmAddStock(event);">
                <input type="number" name="added_qty" min="1" max="1000" 
                       placeholder="Qty" class="form-control form-control-sm mb-1" required>
                <button type="submit" class="btn btn-sm btn-success w-100">
                  <i class="fas fa-plus"></i> Add
                </button>
              </form>

              <!-- Deduct Stock -->
              <form action="{{ url_for('deduct_stock', product_id=product.id) }}" 
                    method="POST" 
                    class="stock-form-vertical"
                    onsubmit="return confirmDeductStock(event);">
                <input type="number" name="deduct_qty" min="1" 
                       placeholder="Qty" class="form-control form-control-sm mb-1" required>
                <button type="submit" class="btn btn-sm btn-danger w-100">
                  <i class="fas fa-minus"></i> Deduct
                </button>
              </form>
            </div>
          </td>
          {% endif %}
        </tr>
        {% endfor %}
        
        {% if not products %}
        <tr>
          <td colspan="12" class="text-center py-5 text-muted">
            <i class="fas fa-box-open fa-3x mb-3 opacity-50"></i>
            <p>No products found{% if search_query %} matching "{{ search_query }}"{% endif %}.</p>
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<script>
function confirmAddStock(event) {
  const qty = event.target.querySelector('input[name="added_qty"]').value;
  return confirm(`âž• Add ${qty} unit(s) to stock?`);
}

function confirmDeductStock(event) {
  const qty = event.target.querySelector('input[name="deduct_qty"]').value;
  return confirm(`âž– Deduct ${qty} unit(s) from stock? This cannot be undone!`);
}
</script>

{% endblock %}